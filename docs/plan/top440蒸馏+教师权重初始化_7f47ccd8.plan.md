---
name: top440蒸馏+教师权重初始化
overview: 改用 top440 教师 + 440-class 学生 + 教师权重切片初始化。仅需修改 train_distill.py（加 --init_from_teacher）和 run_distill.sh（加参数支持）两个文件，无需新增 config。
todos:
  - id: add-init-from-teacher
    content: 在 train_distill.py 中新增 --init_from_teacher 参数和 _init_student_from_teacher() 函数
    status: completed
  - id: update-run-distill-sh
    content: 在 run_distill.sh 中新增 init_from_teacher 变量并传递给 python 命令
    status: completed
isProject: false
---

# Top440 教师蒸馏 + 教师权重切片初始化

## 问题回顾

当前 20-class 蒸馏已收敛失败：

- cv_loss plateau 在 16.3（教师是 12.9），LR 已降到 6.25e-05
- 根因：20 类输出梯度信号太弱 + 随机初始化起点太差

## 方案

使用 top440 作为教师（440 类、置信度 0.999），学生也用 440 类输出，并从教师权重截取切片初始化 backbone。

- 教师: `exp/fsmn_ctc_top440_weight_surgery/24.pt`（4 层, 250/128, backbone 389K + head 62K = 451K）
- 学生: FSMN-mini（3 层, 160/64/96/96, backbone 134K + head 42K = **176K**）
- Dict: `dict_top440`
- 训练完成后可 weight-surgery 到 20 class 部署（回到 ~136K）

## 需要改动的文件（仅 2 个）

### 1. `wekws/bin/train_distill.py` -- 新增 init_from_teacher

新增命令行参数：

```python
parser.add_argument('--init_from_teacher',
                    default=False,
                    type=lambda x: str(x).lower() == 'true',
                    help='initialize student from teacher weights (slice)')
```

新增函数 `_init_student_from_teacher(student_model, teacher_model)`：

```python
def _init_student_from_teacher(student_model, teacher_model):
    """从教师权重截取切片初始化学生。
    对每个参数：shape 完全一致则直接复制，学生维度 <= 教师则截取前 N 行/列。
    """
    s_state = student_model.state_dict()
    t_state = teacher_model.state_dict()
    initialized = []
    for key in s_state:
        if key not in t_state:
            continue
        s_shape = s_state[key].shape
        t_shape = t_state[key].shape
        if s_shape == t_shape:
            s_state[key] = t_state[key].clone()
            initialized.append(key)
        elif (len(s_shape) == len(t_shape)
              and all(s <= t for s, t in zip(s_shape, t_shape))):
            slices = tuple(slice(0, s) for s in s_shape)
            s_state[key] = t_state[key][slices].clone()
            initialized.append(f"{key} (sliced {list(t_shape)}->{list(s_shape)})")
    student_model.load_state_dict(s_state)
    return initialized
```

调用位置：在创建学生模型之后、DDP 包装之前，加载教师之后：

```python
# ---- Init student from teacher weights ----
if args.init_from_teacher:
    initialized = _init_student_from_teacher(student_model, teacher_model)
    logging.info('Initialized %d/%d student params from teacher',
                 len(initialized), len(s_state))
```

典型的切片对应关系（教师 4 层 250/128/140 -> 学生 3 层 160/64/96）：

- `in_linear1.weight`: (140, 400) -> (96, 400) 取前 96 行
- `in_linear2.weight`: (250, 140) -> (160, 96) 取前 160x96
- `fsmn.{0,1,2}` 的 LinearTransform/FSMNBlock/AffineTransform: 各维度取前 N
- `out_linear1.weight`: (140, 250) -> (96, 160) 取前 96x160
- `out_linear2.weight`: (440, 140) -> (440, 96) 取前 96 列（440 维保持一致）
- 学生只有 3 层 FSMN block（教师 block 3 的权重自动跳过，因为 key 不存在）

### 2. `examples/hi_xiaowen/s0/run_distill.sh` -- 新增参数

新增变量和 parse_options 参数：

```bash
init_from_teacher=false
```

传递到 python 命令：

```bash
--init_from_teacher $init_from_teacher
```

## 运行命令

```bash
bash run_distill.sh \
  --teacher_checkpoint exp/fsmn_ctc_top440_weight_surgery/24.pt \
  --dict_dir dict_top440 \
  --num_keywords 440 \
  --target_exp_dir exp/fsmn_ctc_distill_mini_440 \
  --init_from_teacher true \
  2 3
```

无需新增 config yaml（`conf/fsmn_ctc_student_mini.yaml` 的 backbone 参数不变，`output_dim` 由 `--num_keywords 440` 命令行覆盖）。